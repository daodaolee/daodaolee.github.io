<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Webpack 核心流程</title>
    <meta name="description" content="A VitePress site">
    <link rel="stylesheet" href="/assets/style.b4de4daf.css">
    <link rel="modulepreload" href="/assets/chunks/Home.84031245.js">
    <link rel="modulepreload" href="/assets/chunks/Navbar.7a2e2f08.js">
    <link rel="modulepreload" href="/assets/chunks/Page.298bf9fa.js">
    <link rel="modulepreload" href="/assets/chunks/Post.8123d9ef.js">
    <link rel="modulepreload" href="/assets/chunks/Movie.e7531bdd.js">
    <link rel="modulepreload" href="/assets/app.ec7a89e7.js">
    <link rel="modulepreload" href="/assets/posts_webpack_core.md.d6397305.lean.js">
    
    <link rel="icon" href="/favicon.ico">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><div><header class="w-100vw p-6 flex items-center justify-between fixed" data-v-29c3ee47><a href="/" data-v-29c3ee47><img src="/logo-black.webp" class="w-10 h-10" data-v-29c3ee47></a><div class="nav-icons flex items-center gap-5" data-v-29c3ee47><!--[--><a target="_self" href="/posts/" class="cursor-pointer op-60 transition-colors-300" data-v-29c3ee47><div text-xl class="md:hidden" data-v-29c3ee47><div class="i-ri-article-line icon" data-v-29c3ee47></div></div><span text-sm ml-1 class="lt-md:hidden" data-v-29c3ee47>Posts</span></a><a target="_self" href="/movies/" class="lt-md:hidden cursor-pointer op-60 transition-colors-300" data-v-29c3ee47><!----><span text-sm ml-1 class="lt-md:hidden" data-v-29c3ee47>Movies</span></a><a target="_blank" href="https://github.com/daodaolee" class="lt-md:hidden cursor-pointer op-60 transition-colors-300" data-v-29c3ee47><div text-xl class="" data-v-29c3ee47><div class="i-ri:github-line icon" data-v-29c3ee47></div></div><!----></a><a target="_blank" href="https://twitter.com/daodaolee_" class="lt-md:hidden cursor-pointer op-60 transition-colors-300" data-v-29c3ee47><div text-xl class="" data-v-29c3ee47><div class="i-ri:twitter-line icon" data-v-29c3ee47></div></div><!----></a><a target="_blank" href="https://www.instagram.com/daodaoleee/" class="lt-md:hidden cursor-pointer op-60 transition-colors-300" data-v-29c3ee47><div text-xl class="" data-v-29c3ee47><div class="i-ri-instagram-line icon" data-v-29c3ee47></div></div><!----></a><a target="_blank" href="https://dribbble.com/daodaolee" class="lt-md:hidden cursor-pointer op-60 transition-colors-300" data-v-29c3ee47><div text-xl class="" data-v-29c3ee47><div class="i-ri-dribbble-line icon" data-v-29c3ee47></div></div><!----></a><a target="_blank" href="https://space.bilibili.com/294106298?spm_id_from=333.1007.0.0" class="lt-md:hidden cursor-pointer op-60 transition-colors-300" data-v-29c3ee47><div text-xl class="" data-v-29c3ee47><div class="i-ri-bilibili-fill icon" data-v-29c3ee47></div></div><!----></a><!--]--><a class="cursor-pointer op-60" data-v-29c3ee47><div class="i-ri:sun-line icon" data-v-29c3ee47></div></a></div></header><main class="content max-w-73ch mx-auto px-6 md:px-0 pb-15"><div class="pt-25"><div class="mb-8"><h1 class="title mt-0 text-2.2rem mb-5">Webpack 核心流程</h1><div class="op-60 flex items-end"><span>Mar 23, 2022</span><div class="text-0.85rem pl-1.8rem"><!--[--><span> #webpack  </span><span> #js  </span><!--]--></div></div></div><div style="position:relative;" class="page"><div><nav class="table-of-contents"><ul><li><a href="#前提简介">前提简介</a></li><li><a href="#一、初始化">一、初始化</a><ul><li><a href="#简要步骤">简要步骤</a></li><li><a href="#具体步骤">具体步骤</a></li></ul></li><li><a href="#二、构建">二、构建</a><ul><li><a href="#简要步骤-1">简要步骤</a></li><li><a href="#具体步骤-1">具体步骤</a></li></ul></li><li><a href="#三、生成">三、生成</a><ul><li><a href="#简要步骤-2">简要步骤</a></li><li><a href="#具体步骤-2">具体步骤</a></li></ul></li><li><a href="#总结">总结</a></li></ul></nav><p><em><a href="https://segmentfault.com/a/1190000039956437" target="_blank" rel="noreferrer">原文地址</a></em></p><h2 id="前提简介" tabindex="-1">前提简介 <a class="header-anchor" href="#前提简介" aria-hidden="true">#</a></h2><ul><li><code>Entry</code>：编译入口，webpack 编译的起点</li><li><code>Compiler</code>：编译管理器，webpack 启动后会创建 <code>compiler</code> 对象，该对象一直存活知道结束退出</li><li><code>Compilation</code>：单次编辑过程的管理器，比如 <code>watch = true</code> 时，运行过程中只有一个 <code>compiler</code> 但每次文件变更触发重新编译时，都会创建一个新的 <code>compilation</code> 对象</li><li><code>Dependence</code>：依赖对象，webpack 基于该类型记录模块间依赖关系</li><li><code>Module</code>：webpack 内部所有资源都会以“module”对象形式存在，所有关于资源的操作、转译、合并都是以 “module” 为基本单位进行的</li><li><code>Chunk</code>：编译完成准备输出时，webpack 会将 <code>module</code> 按特定的规则组织成一个一个的 <code>chunk</code>，这些 <code>chunk</code> 某种程度上跟最终输出一一对应</li><li><code>Loader</code>：资源内容转换器，其实就是实现从内容 A 转换 B 的转换器</li><li><code>Plugin</code>：webpack构建过程中，会在特定的时机广播对应的事件，插件监听这些事件，在特定时间点介入编译过程</li></ul><h2 id="一、初始化" tabindex="-1">一、初始化 <a class="header-anchor" href="#一、初始化" aria-hidden="true">#</a></h2><h3 id="简要步骤" tabindex="-1">简要步骤 <a class="header-anchor" href="#简要步骤" aria-hidden="true">#</a></h3><ol><li>初始化参数，从配置文件、配置对象、Shell 参数中读取，和默认配置结合出最终参数</li><li>创建编译器对象，用 1 的结果创建 <code>Compliler</code> 对象</li><li>初始化编译环境，包括注入内置插件，注册各种模块工厂，初始化 <code>RuleSet</code> 集合，加载插件等</li><li>开始编译，执行 <code>compiler</code> 对象的 <code>run</code> 方法</li></ol><h3 id="具体步骤" tabindex="-1">具体步骤 <a class="header-anchor" href="#具体步骤" aria-hidden="true">#</a></h3><p>下图是 <strong>1</strong> 到 <strong>3</strong> 的流程图：</p><p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/1648043519010webpack1.png" alt=""></p><p>至此，<code>Compiler</code> 对象被构建出来</p><h2 id="二、构建" tabindex="-1">二、构建 <a class="header-anchor" href="#二、构建" aria-hidden="true">#</a></h2><blockquote><p><strong>构建主要围绕的是 <code>module</code></strong></p></blockquote><h3 id="简要步骤-1" tabindex="-1">简要步骤 <a class="header-anchor" href="#简要步骤-1" aria-hidden="true">#</a></h3><ol><li><p>找到入口</p><p>根据配置的 <code>entry</code> 找到入口，调用 <code>compilition.addEntry</code>，将入口文件转换为 <code>dependence</code></p></li><li><p>编译模块（make）</p><p>根据 <code>entry</code> 对应的 <code>dependence</code> 创建 <code>module</code> 对象，调用 <code>loader</code> 将模块转换为标准的 <code>JS</code> 内容，再调用 <code>JS</code> 解释器将内容转换为 <code>AST</code> 对象，从中找出模块的依赖模块，再递归本步骤，直到所有入口所依赖的文件都处理完毕</p></li><li><p>完成模块编译</p><p>上一步递归结束，会得到每个模块被处理后的结果，以及它们的 <strong>依赖关系图</strong></p></li></ol><h3 id="具体步骤-1" tabindex="-1">具体步骤 <a class="header-anchor" href="#具体步骤-1" aria-hidden="true">#</a></h3><p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/16480415301872.png" alt=""></p><p>该过程：<code>module =&gt; AST =&gt; dependences =&gt; module</code>，先转 AST，再从 AST 中找依赖，所以就需要 <code>loader</code> 加载后的结果必须是可以被 <code>acron</code> 处理的 JS 标准语法。</p><p><code>compilation</code> 按这个流程递归处理，逐步解析出每个模块的内容以及 <code>module</code> 依赖关系，后续就可以根据这些内容打包输出。</p><h2 id="三、生成" tabindex="-1">三、生成 <a class="header-anchor" href="#三、生成" aria-hidden="true">#</a></h2><blockquote><p><strong>生成主要围绕的是 <code>chunk</code></strong></p></blockquote><h3 id="简要步骤-2" tabindex="-1">简要步骤 <a class="header-anchor" href="#简要步骤-2" aria-hidden="true">#</a></h3><ol><li><p>输出资源（seal）</p><p>根据得到的依赖关系图，组装成一个个包含多个模块的 <code>chunk</code>，再把每个 <code>chunk</code> 转换成一个单独的文件并添加到输出列表，<strong>这一步是可以修改输出内容的最后机会</strong></p></li><li><p>写入文件系统（emitAssets）</p></li></ol><p>确定好输出内容后，根据配置的路径和文件名，写入到文件系统中</p><h3 id="具体步骤-2" tabindex="-1">具体步骤 <a class="header-anchor" href="#具体步骤-2" aria-hidden="true">#</a></h3><p><img src="https://cdn.jsdelivr.net/gh/daodaolee/photobed@main/img/16480426731243.png" alt=""></p><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-hidden="true">#</a></h2><p>整体的代码：</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vp-code-dark"><code><span class="line"><span style="color:#758575DD;">// 取自 webpack/lib/compiler.js </span></span>
<span class="line"><span style="color:#80A665;">compile</span><span style="color:#666666;">(</span><span style="color:#BD976A;">callback</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">params</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">newCompilationParams</span><span style="color:#666666;">();</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#758575DD;">// 构建之前</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">hooks</span><span style="color:#666666;">.</span><span style="color:#BD976A;">beforeCompile</span><span style="color:#666666;">.</span><span style="color:#80A665;">callAsync</span><span style="color:#666666;">(</span><span style="color:#BD976A;">params</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">err</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 创建 compilation</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">compilation</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#80A665;">newCompilation</span><span style="color:#666666;">(</span><span style="color:#BD976A;">params</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">// 执行 make</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">hooks</span><span style="color:#666666;">.</span><span style="color:#BD976A;">make</span><span style="color:#666666;">.</span><span style="color:#80A665;">callAsync</span><span style="color:#666666;">(</span><span style="color:#BD976A;">compilation</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">err</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#758575DD;">// 结束 make</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#C99076;">this</span><span style="color:#666666;">.</span><span style="color:#BD976A;">hooks</span><span style="color:#666666;">.</span><span style="color:#BD976A;">finishMake</span><span style="color:#666666;">.</span><span style="color:#80A665;">callAsync</span><span style="color:#666666;">(</span><span style="color:#BD976A;">compilation</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">err</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">// ...</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">process</span><span style="color:#666666;">.</span><span style="color:#80A665;">nextTick</span><span style="color:#666666;">(()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">          </span><span style="color:#758575DD;">// compilation 结束</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#BD976A;">compilation</span><span style="color:#666666;">.</span><span style="color:#80A665;">finish</span><span style="color:#666666;">(</span><span style="color:#BD976A;">err</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">// seal 执行</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">compilation</span><span style="color:#666666;">.</span><span style="color:#80A665;">seal</span><span style="color:#666666;">(</span><span style="color:#BD976A;">err</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{...});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">          </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">      </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#666666;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">// 取自 webpack/lib/compiler.js </span></span>
<span class="line"><span style="color:#59873A;">compile</span><span style="color:#999999;">(</span><span style="color:#B07D48;">callback</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">params</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">newCompilationParams</span><span style="color:#999999;">();</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#A0ADA0;">// 构建之前</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">hooks</span><span style="color:#999999;">.</span><span style="color:#B07D48;">beforeCompile</span><span style="color:#999999;">.</span><span style="color:#59873A;">callAsync</span><span style="color:#999999;">(</span><span style="color:#B07D48;">params</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">err</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 创建 compilation</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">compilation</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#59873A;">newCompilation</span><span style="color:#999999;">(</span><span style="color:#B07D48;">params</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">// 执行 make</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">hooks</span><span style="color:#999999;">.</span><span style="color:#B07D48;">make</span><span style="color:#999999;">.</span><span style="color:#59873A;">callAsync</span><span style="color:#999999;">(</span><span style="color:#B07D48;">compilation</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">err</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#A0ADA0;">// 结束 make</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">.</span><span style="color:#B07D48;">hooks</span><span style="color:#999999;">.</span><span style="color:#B07D48;">finishMake</span><span style="color:#999999;">.</span><span style="color:#59873A;">callAsync</span><span style="color:#999999;">(</span><span style="color:#B07D48;">compilation</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">err</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">// ...</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">process</span><span style="color:#999999;">.</span><span style="color:#59873A;">nextTick</span><span style="color:#999999;">(()</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">          </span><span style="color:#A0ADA0;">// compilation 结束</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#B07D48;">compilation</span><span style="color:#999999;">.</span><span style="color:#59873A;">finish</span><span style="color:#999999;">(</span><span style="color:#B07D48;">err</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">// seal 执行</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">compilation</span><span style="color:#999999;">.</span><span style="color:#59873A;">seal</span><span style="color:#999999;">(</span><span style="color:#B07D48;">err</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{...});</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">          </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">      </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#999999;">}</span></span>
<span class="line"></span></code></pre></div></div></div></div></main></div></div><div class="text-center text-[14px] pt-10 pb-2 scale-80 color-[black]" style="letter-spacing:0.2rem;"><a href="https://beian.miit.gov.cn/">浙ICP备2022027583号</a></div><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"78f3a6e0\",\"movies_index.md\":\"6d564773\",\"posts_async.md\":\"c7940291\",\"posts_chrome_workflow.md\":\"dfdcf7cb\",\"posts_csp.md\":\"8b1e0799\",\"posts_eventloop.md\":\"c6caf8e8\",\"posts_form.md\":\"3add2ce3\",\"posts_friends_of_time_2023.md\":\"71b69490\",\"posts_git.md\":\"c90465ed\",\"posts_http_option.md\":\"9997527c\",\"posts_index.md\":\"279f248e\",\"posts_promise_next.md\":\"58ff639f\",\"posts_promise_prev.md\":\"4ddfbc45\",\"posts_rebuild_mac.md\":\"1be3b152\",\"posts_refactor_js.md\":\"76f8eb20\",\"posts_render_on_the_web.md\":\"0b11ff2c\",\"posts_restudy_function.md\":\"34c408f6\",\"posts_restudy_obj.md\":\"2fb56604\",\"posts_restudy_scope.md\":\"de7f7b3d\",\"posts_sourcemap.md\":\"259901c9\",\"posts_summary_2011.md\":\"ac21b29a\",\"posts_svg.md\":\"60324705\",\"posts_translate.md\":\"4dddf28e\",\"posts_vscode_setting.md\":\"26038331\",\"posts_vuepress_plugin_awesome_musicplayer.md\":\"8c0097a3\",\"posts_webpack_core.md\":\"d6397305\"}")</script>
    <script type="module" async src="/assets/app.ec7a89e7.js"></script>
    
  </body>
</html>