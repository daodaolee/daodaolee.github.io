---
title: Promiseã€çŸ¥å…¶ç„¶ã€‘
date: 2021-01-30 22:28:15
tags:
 - promise
---
[[toc]]

è¦æƒ³æŒæ¡ `Promise`ï¼Œå…ˆä»æ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•å…¥æ‰‹ï¼Œè€Œååˆ¨æ ¹å®ƒçš„åŸç†ï¼Œæ–¹å¯å¤§æˆã€‚

## æ¦‚å¿µ

 æŠ›å»æ‰€æœ‰å’Œå®ƒæœ‰å…³çš„ä¸œè¥¿ï¼Œ`Promise` è¿™ä¸ªè¯ï¼Œç¿»è¯‘è¿‡æ¥æ˜¯ **æ‰¿è¯º** çš„æ„æ€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥çŒœæƒ³ï¼Œå®ƒæ˜¯ä¸æ˜¯ä¸€ä¸ªæœ‰å…³é€»è¾‘çŠ¶æ€çš„ä¸œè¥¿å‘¢ã€‚

**`Promise` æ˜¯ä¸€ä¸ªå¯¹è±¡**ï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ **å®Œæˆ** æˆ–è€… **å¤±è´¥**ï¼Œæœ¬è´¨ä¸Šå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°è¿”å›çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»–ä¸Šé¢ç»‘å®šå›è°ƒå‡½æ•°ï¼Œè¿™æ ·å°±ä¸éœ€è¦åœ¨ä¸€å¼€å§‹æŠŠå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ä¼ å…¥è¿™ä¸ªå‡½æ•°äº†ã€‚

æ„æ€æ˜¯è¯´ï¼š

1. é¦–å…ˆæˆ‘ä»¬è®¤å®šäº† `Promise`æ˜¯ä¸€ä¸ªå‡½æ•°
2. å®ƒæ˜¯ä¸€ä¸ªè¿”å›äº†ç®¡ç†å¼‚æ­¥æ“ä½œçŠ¶æ€(æˆåŠŸ / å¤±è´¥)çš„å‡½æ•°
3. å®ƒé»˜è®¤ç»‘å®šäº†å›è°ƒå‡½æ•°
4. å®ƒçš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡

é‚£æˆ‘ä»¬å¯ä»¥å°è¯•ç€å†™ä¸€ä¸ª **ä¼ªPromise**

```js
function fn(params) {
  const successCallback = result => {
    return result
  }
  const failedCallback = error => {
    return error
  }
  
  return {params, successCallback, failedCallback};
}
// 1. å¯ä»¥è¿™æ ·è°ƒç”¨
const promise = fn(params);
promise.then(successCallback, failedCallback);
// 2. ä¹Ÿå¯ä»¥è¿™æ ·è°ƒç”¨
fn(params).then(successCallback, failedCallback);
```

æˆ‘ä»¬æŠŠè¿™ç§°ä¸º *å¼‚æ­¥å‡½æ•°è°ƒç”¨* ï¼Œåœ¨ä½¿ç”¨ `Promise` çš„æ—¶å€™ï¼Œä¼šæœ‰ä»¥ä¸‹çº¦å®šï¼š

1. åœ¨æœ¬è½®äº‹ä»¶å¾ªç¯è¿è¡Œå®Œæˆä¹‹å‰ï¼Œå›è°ƒå‡½æ•°æ˜¯ä¸ä¼šè¢«è°ƒç”¨çš„
2. å³ä½¿å¼‚æ­¥æ“ä½œç»“æŸï¼Œåœ¨è¿™ä¹‹åé€šè¿‡ `then()` æ·»åŠ çš„å›è°ƒå‡½æ•°ä¹Ÿä¼šè¢«æ‰§è¡Œ
3. é€šè¿‡ `then()` å¯ä»¥æ·»åŠ å¤šä¸ªå›è°ƒå‡½æ•°ï¼Œå®ƒä»¬æŒ‰ç…§æ’å…¥çš„é¡ºåºä¾æ¬¡æ‰§è¡Œ

æ‰€ä»¥ï¼š`Promise` å¾ˆæ£’çš„ä¸€ç‚¹å°±æ˜¯ **é“¾å¼è°ƒç”¨**ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡é“¾å¼è°ƒç”¨ç®€å•ä½¿ç”¨ä¸€ä¸‹ã€‚

## ç®€å•ä½¿ç”¨

æˆ‘ä»¬å…ˆæ¨¡æ‹Ÿä¸€ä¸ªç¯å¢ƒï¼šè¿ç»­æ‰§è¡Œå¤šä¸ªå¼‚æ­¥æ“ä½œï¼Œä¸Šä¸ªæ“ä½œç»“æŸåï¼Œæ‰å¼€å§‹ä¸‹ä¸€ä¸ªï¼Œå¹¶å¸¦ä¸Šä¸Šä¸€ä¸ªçš„è¿”å›å€¼ã€‚

```js
// å¯ä»¥è¿™æ ·å†™
const promise1 = fn();
const promise2 = promise.then(successCB, failedCB);

//ä¹Ÿå¯ä»¥è¿™æ ·å†™
const promise2 = fn().then(successCB, failedCB);
```

åœ¨ä¸Šé¢çš„ä¾‹å­é‡Œï¼Œ `Promise2` è¡¨ç¤º `fn`() å‡½æ•°çš„å®Œæˆï¼Œä¹Ÿè¡¨ç¤ºäº†ä¼ å…¥çš„` successCB()` æˆ–è€… `failedCB()` çš„å®Œæˆï¼Œå½“ç„¶è¿™ä¸¤ä¸ªå‡½æ•°ä¹Ÿè¿”å›äº†ä¸€ä¸ª Promise å¯¹è±¡ï¼Œä»è€Œå½¢æˆä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚

æ­¤åˆ»æˆ‘ä»¬å°±è§£å†³äº† *å›è°ƒåœ°åŸŸ* çš„é—®é¢˜ï¼š

```js
fn(result => {
  fn1(result, newResult => {
    fn2(newResult, finalResult => {
      //do something...
    }, failedCB)
  }, failedCB)
}, failedCB)
```

ä¸Šé¢çš„å›è°ƒåœ°åŸŸï¼Œæˆ‘ä»¬æŠŠå›è°ƒç»‘å®šåˆ° Promise ä¸Šï¼Œå½¢æˆä¸€ä¸ª Promise é“¾ï¼Œå†çœ‹ï¼š

```js
fn().then(result => {
	return fn1(result);	
}).then(newResult => {
  return fn2(newResult);
}).then(finalResult => {
  //do something...
}).catch(failedCB)

//ä¸Šæ–¹çš„catch(failedCB) å°±æ˜¯ then(null, failedCB)çš„ç¼©å†™
```

çœ‹èµ·æ¥æ¸…çˆ½äº†å¾ˆå¤šğŸ‰ã€‚

é‚£ä¹ˆåœ¨è¿™ä¸ªæ—¶å€™è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœåœ¨ä¸€ä¸ªé“¾å¼æ“ä½œä¸­ï¼Œä½¿ç”¨äº†ä¸€ä¸ª `catch()`ï¼Œå†æ¬¡ç»§ç»­å›è°ƒæ€ä¹ˆåŠï¼Ÿ

```js
new Promise((resolve, reject) => {
    console.log('åˆå§‹åŒ–');
    resolve();
})
.then(() => {
    throw new Error('æœ‰å“ªé‡Œä¸å¯¹äº†');
    console.log('æ‰§è¡Œã€Œè¿™ä¸ªã€');
})
.catch(() => {
    console.log('æ‰§è¡Œã€Œé‚£ä¸ªã€');
})
.then(() => {
    console.log('æ‰§è¡Œã€Œè¿™ä¸ªã€ï¼Œæ— è®ºå‰é¢å‘ç”Ÿäº†ä»€ä¹ˆ');
});

// 	åˆå§‹åŒ–
// 	æ‰§è¡Œâ€œé‚£ä¸ªâ€
// 	æ‰§è¡Œâ€œè¿™ä¸ªâ€ï¼Œæ— è®ºå‰é¢å‘ç”Ÿäº†ä»€ä¹ˆ
```

**æ³¨æ„**ï¼šå› ä¸ºæŠ›å‡ºäº†é”™è¯¯ *æœ‰å“ªé‡Œä¸å¯¹äº†*ï¼Œæ‰€ä»¥å‰ä¸€ä¸ª *æ‰§è¡Œã€Œè¿™ä¸ªã€* æ²¡æœ‰è¢«è¾“å‡ºã€‚

## æ—¶åºé—®é¢˜

åœ¨ç†æƒ³çŠ¶æ€ä¸‹ï¼Œæ‰€æœ‰çš„å¼‚æ­¥å‡½æ•°å…¶å®éƒ½å·²ç»è¿”å›äº† Promise äº†ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰äº›ç‰¹æ®Šçš„å›è°ƒæ¯”å¦‚å®šæ—¶å™¨ï¼Œå¦‚æœæ··ç”¨ Promise å’Œ å®šæ—¶å™¨ å¯èƒ½ä¼šé€ æˆæ—¶åºé—®é¢˜ï¼Œæ‰€ä»¥ï¼Œæœ€å¥½çš„åšæ³•æ˜¯æŠŠæœ‰é—®é¢˜çš„å‡½æ•°å°è£…ï¼Œæ°¸è¿œä¸è¦ç›´æ¥è°ƒç”¨å®ƒä»¬ï¼š

```js
const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

wait(1000).then(()=>{fn()})
```

`then()` æ–¹æ³•çš„å‡½æ•°ä¼šè¢«æ”¾åˆ°ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè€Œä¸æ˜¯ç«‹å³æ‰§è¡Œï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯åœ¨JSäº‹ä»¶é˜Ÿåˆ—çš„æ‰€æœ‰è¿è¡Œæ—¶ç»“æŸäº†ï¼Œå¹¶ä¸”äº‹ä»¶é˜Ÿåˆ—è¢«æ¸…ç©ºäº†ä¹‹åï¼Œæ‰å¼€å§‹æ‰§è¡Œçš„ã€‚

```js
Promise.resolve().then(() => console.log(2)).then(() => console.log(3));
console.log(1); // 1, 2, 3, 4
```

*åæœŸä¼šè¡¥ä¸€ç¯‡å¾ªç¯æœºåˆ¶çš„æ–‡ç« ï¼Œä¸“é—¨è®²ä¸‹äº‹ä»¶é˜Ÿåˆ—*ã€‚

## å¹¶è¡Œ

å¹³å¸¸ç”¨çš„æ¯”è¾ƒå¤šçš„å°±æ˜¯ `Promise.all()` å’Œ `Promise.race()` äº†ï¼Œå®ƒä»¬ä¸¤ä¸ªæ˜¯å¹¶è¡Œè¿è¡Œå¼‚æ­¥çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯éƒ½æ‰§è¡Œå®Œä¹‹åæ‰å¯ä»¥æ“ä½œç»“æœï¼Œä½†æ˜¯åå¤„å°±æ˜¯åªè¦æœ‰ä¸€ä¸ªå¤±è´¥ï¼Œå°±ä¼šä¸­æ–­å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚

```js
Promise.all([fn1(), fn2()])
	.then(result => {
  // [result1,result2]
}).catch(err => {
  //è¿”å›æœ€å…ˆè¢«rejectå¤±è´¥çš„çŠ¶æ€
})
```

`Promise.race()` ä¸ `Promise.all() ` ä¸ä¸€æ ·çš„åœ°æ–¹å°±æ˜¯ï¼ŒæŒ‰èµ°å®Œçš„æ—¶é—´é¡ºåºæ’åºç»“æœã€‚

```js
Promise.all([fn1(), fn2()])
	.then(result => {
  // [result2, result1] or [result1, result2]
})
```

**æ³¨æ„ï¼šä¸€å®šè¦åœ¨ `then()` æ–¹æ³•é‡Œè¿”å›ä¸€ä¸ª Promise å¯¹è±¡(æ€»æ˜¯è¿”å›æˆ–ç»ˆæ­¢ Promise)ï¼Œè¿™æ ·æ‰æ˜¯ä¸€æ¡å®Œæ•´çš„å¯å¼‚æ­¥æ‰§è¡Œçš„é“¾ã€‚**



ä¸Šé¢ç®€å•çš„æŠŠ `Promise` çš„æ¦‚å¿µå’Œç®€å•ä½¿ç”¨é˜è¿°äº†ä¸€ä¸‹ï¼Œä¸»è¦é’ˆå¯¹çš„æ˜¯å¯¹ promise ä¸ç†Ÿæ‚‰çš„æœ‹å‹ï¼Œä¹Ÿç®—æ˜¯ä¸€ä¸ªç®€å•çš„å›é¡¾ã€‚â€œçŸ¥å…¶æ‰€ä»¥ç„¶ã€Promiseç¯‡ã€‘â€œ ä¼šæŠŠé‡Œé¢çš„ç»†èŠ‚è®²ä¸€ä¸‹ã€‚



å‚è€ƒèµ„æ–™ï¼š

* [ä½¿ç”¨Promise](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Using_promises)
* [å¤§ç™½è¯è®²è§£Promiseï¼ˆä¸€ï¼‰](https://www.cnblogs.com/lvdabao/p/es6-promise-1.html)
* [è¿™æ˜¯ä¸€ç¯‡å‚»ç“œéƒ½èƒ½çœ‹æ‡‚çš„Promisesæ–‡ç« ï¼](https://zhuanlan.zhihu.com/p/24684803)
* [ä»€ä¹ˆæ˜¯Promise](https://wiki.jikexueyuan.com/project/javascript-promise-mini-book/what-is-the-promise.html)